<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KOIFSH — Add Post</title>
<link rel="stylesheet" href="style.css" />
<style>
.card{border:1px solid var(--line);border-radius:16px;padding:18px;background:rgba(255,255,255,.01);}
label{display:block;color:var(--muted);font-size:13px;margin:12px 0 6px;}
input,textarea{
  width:100%;
  border:1px solid var(--line);
  border-radius:12px;
  padding:10px 12px;
  background:transparent;
  color:var(--fg);
  font:16px/1.5 system-ui, sans-serif;
}
textarea{min-height:160px;white-space:pre-wrap;}
.btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px;}
button{
  border:1px solid var(--line);
  border-radius:999px;
  padding:10px 14px;
  background:transparent;
  color:var(--fg);
  cursor:pointer;
}
button:hover{background:rgba(255,255,255,.05);}
.status{font-size:13px;color:var(--muted);}
</style>
</head>
<body>
<div class="wrap">

<h1>Add Post</h1>
<p><a href="index.html">← Back to Archive</a></p>

<div class="card">

<button id="fetch">Fetch latest from Instagram</button>
<span id="fetchStatus" class="status"></span>

<label>Number</label>
<input id="n" placeholder="12" />

<label>Song Title</label>
<input id="title" placeholder="Never Forget" />

<label>Caption</label>
<textarea id="caption"></textarea>

<label>Spotify (optional)</label>
<input id="spotify" />

<label>Apple (optional)</label>
<input id="apple" />

<div class="btns">
<button id="submit">Submit to Site</button>
<span id="submitStatus" class="status"></span>
</div>

</div>
</div>

<script>
const $ = id => document.getElementById(id);

function buildObj(){
  return {
    n: parseInt($("n").value,10),
    title: $("title").value.trim(),
    caption: $("caption").value.trim(),
    spotify: $("spotify").value.trim(),
    apple: $("apple").value.trim()
  };
}

$("fetch").onclick = async () => {
  $("fetchStatus").textContent = "Fetching…";
  try{
    const res = await fetch("/.netlify/functions/fetch-latest-ig");
    const data = await res.json();

    $("caption").value = data.caption || "";
    if(data.parsed?.n) $("n").value = data.parsed.n;
    if(data.parsed?.title) $("title").value = data.parsed.title;
    if(data.detected?.spotify) $("spotify").value = data.detected.spotify;
    if(data.detected?.apple) $("apple").value = data.detected.apple;

    $("fetchStatus").textContent = "Loaded.";
  }catch{
    $("fetchStatus").textContent = "Fetch failed.";
  }
};

$("submit").onclick = async () => {
  $("submitStatus").textContent = "Submitting…";
  try{
    const res = await fetch("/.netlify/functions/add-post", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(buildObj())
    });
    const data = await res.json();
    if(!res.ok) throw new Error(data.error);

    $("submitStatus").textContent = "Committed. Netlify redeploying…";
  }catch(e){
    $("submitStatus").textContent = "Submit failed.";
  }
};
</script>
</body>
</html>
